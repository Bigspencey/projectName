rbAdd("productLaunch.pdp.countdownHours", "hours"); rbAdd("productLaunch.pdp.countdownMinutes", "min"); rbAdd("productLaunch.pdp.countdownSeconds", "sec"); rbAdd("productLaunch.pdp.disclaimer", "Please note: Your order is not finalized until the checkout process is complete and you receive a shipment confirmation email."); rbAdd("common.text.backOrderedMessage", "Back-ordered, Expected to Ship"); rbAdd("common.text.singleStoreInStoreOnly", "Available for purchase in store only"); rbAdd("quickView.button.close", "Close"); /* QuickView v 0.1		 										*/
/* CONFIG: 														*/
/* you can also overwrite this value after including this js 	*/

// Path to QuickView
//var global_quickViewPath = "/quickview/";
// Path to QuickView Button
//var global_quickViewButtonPath = global_quickViewPath + "images/quickview.gif";
// Path to QuickView PDP Template
//var global_quickViewPDPTemplatePath = "/catalog/quickView.cfm";
// Path to QuickView Zoom Image Template
//var global_quickViewZoomImagePath = "/catalog/quickViewZoomImage.cfm";
// Flag for URLRewrite (i.e. /sku--123/model--abc/)
//var global_quickViewUseURLRewrite = false;
// Bottom margin for QuickView Button
var global_quickViewButtonBottomMargin = 10;
// Width of QuickView Panel
var global_quickViewWidth = 520;
var qvImgObject;
/********************************/
/* DO NOT MODIFY CODE BELOW     */
/********************************/

// preload button image so that it would be ready at the time we calculate the height
var global_quickviewButtonImage = new Image();
global_quickviewButtonImage.src = global_quickViewButtonPath;

// set mouseenter/mouseleave event to quickviewEnabled class elements
$(document).ready(function() {
	initializeQuickview();
});

function initializeQuickview() {
	$(".quickViewButtonWrap").unbind();

	$("a.quickviewEnabled").each(function() {
		var URLString = $(this).attr("href");
		URLString = $.trim(URLString);
		
		var wrap = '<span class="quickViewButtonWrap"></span>';
		$(this).wrap(wrap);
		var parentWrap = $(this).parent("span.quickViewButtonWrap");
				
		$(this).removeClass("quickviewEnabled");
		
		var tags = '<a href="javascript:void(0);" title="Open Quick View" class="quickviewButton button" data-btntype="quickview" data-btnname="searchResults_quickview" onmousedown="openQuickViewWithURL(\'' + URLString + '\');"><span></span></a>';

		parentWrap.prepend(tags);
		if(isTouchDevice()){
			//add two extra breaks to display QV button separately from image
			parentWrap.find('br').after("<br />").after("<br />");
		}
		
		qvImgObject = $("img", this);
		
	});

	if(isTouchDevice() && $(".quickViewButtonWrap").length > 0){
		var width = qvImgObject.width();
		var marginTop = (qvImgObject.height() - global_quickviewButtonImage.height - global_quickViewButtonBottomMargin)+25;
		$(".quickviewButton").css({"width": width, "margin-top": marginTop, "display": "inline"});
	}

	else{
		$("span.quickViewButtonWrap").bind("mouseenter", function() {
		// calculate width and top margin for the button
		var width = qvImgObject.width();
		var marginTop = qvImgObject.height() - global_quickviewButtonImage.height - global_quickViewButtonBottomMargin;
		$(this).children(".quickviewButton").css({"width": width, "margin-top": marginTop, "display": "inline"});
	}).bind("mouseleave", function() {
		$(this).children(".quickviewButton").css("display", "none");
	})
	}
}

function stopPropagationHandler(e) {
	e.stopPropagation();
}

function openQuickView(queryString) {
	closeQuickView();

	if ($.browser.msie && $.browser.version == "6.0")
		$("select").css("visibility", "hidden");

	var tags = '<div id="quickview"><div id="quickview_top"><div id="quickview_topRight"></div></div><div id="quickview_middle"><div id="quickview_middleRight"><div id="quickviewLoading"></div><div id="quickviewContent"></div><div style="clear: both"></div></div></div><div id="quickview_bottom"><div id="quickview_bottomRight"><a href="javascript:closeQuickView()" title="Close Quick View"><span class="red">x</span> ' + RBM.quickView.button.close + '</a></div></div></div>';
	$("body").prepend(tags);
	$("#quickviewLoading").css("display", "block");	
	var bodyWidth = $("body").width();
	var leftOffset = (bodyWidth - global_quickViewWidth) / 2;
	var topOffset = getViewpointTop() + ((getViewpointHeight() - $("#quickview").height()) / 2);
	$("#quickview").css({ left: leftOffset, top: topOffset, width: global_quickViewWidth });

	$("#quickviewContent").load(global_quickViewPDPTemplatePath,
		queryString,
		function (responseText, textStatus, XMLHttpRequest) {
			$("#quickviewLoading").css("display", "none");
			if (textStatus != "success") {
				$("#quickview").remove();
				// for debugging
				$("body").html(responseText);
				alert("There was problem loading Quick View for this product. Please try back again later.");
			}
			else {
				var topOffset = getViewpointTop() + ((getViewpointHeight() - $("#quickview").height()) / 2);
				$("#quickview").animate({top: topOffset}, function() {
					if (typeof(quickviewCallbackFunction) == "function")
						quickviewCallbackFunction();
						
						/* workaround to avoid click-through links under quickview in ie */
						var quickviewContentBackground = '<div id="quickviewContentBackground"></div>';
						$("body").prepend(quickviewContentBackground);
						var width = $("#quickviewContent").width();
						var height = $("#quickviewContent").height();
						var offset = $("#quickviewContent").offset();
						var left = offset.left;
						var top = offset.top;
						$("#quickviewContentBackground").css({left: left, top: top, width: width, height: height});

						$('#quickview').click(stopPropagationHandler);
						$('#quickviewContentBackground').click(stopPropagationHandler);

						quickViewBindBackgroundClose();
					}
				);
			}
		}
	);
}

function openQuickViewWithURL(URLString) {
	var queryString = getQueryStringFromURL(URLString);

	if (queryString == null) {
		queryString = getQueryStringFromURLForURLReWrite(URLString);
	}

	if (queryString == null) {
		queryString = getQueryStringFromURLForURLReWriteII(URLString);
	}	
		
	// Grab the coreMetricsDo flag from the 'coremetricsFlag' div in getrows.cfm
	if ($("#coremetricsFlag").length > 0){
		var coremetricsDo   = $("#coremetricsFlag").html().split("=")[0];
		var flag = $("#coremetricsFlag").html().split("=")[1];
		queryString[coremetricsDo] = flag;
	}
	
	
	openQuickView(queryString);	
}

function closeQuickView() {
	if ($.browser.msie && $.browser.version == "6.0")
		$("select").css("visibility", "visible");
	
	if ((typeof(BORISEnabled) != "undefined") && BORISEnabled) {
		//if (typeof(bubble) != "undefined") {
		//	bubble.close();
		//}
		if (typeof(modal) != "undefined" && $.modal.data.isOpen) {
			return;
		}
	}
	
	$("#quickview").remove();
	$("#quickviewContentBackground").remove();
	
	$('#quickview').unbind('click',stopPropagationHandler);
	$('#quickviewContentBackground').unbind('click',stopPropagationHandler);
	quickViewUnbindBackgroundClose();
	//$(document).unbind('click',closeQuickView);	
}

function quickViewBindBackgroundClose(){
	if($("#quickview").length != 0){
		try{
			//$(document).click(closeQuickView);
			$("#quickviewContentBackground").click(closeQuickView);
		} catch (e)  {}
	}
}	

function quickViewUnbindBackgroundClose(){
	if($("#quickview").length != 0){
		try {
			//$(document).unbind('click',closeQuickView);	
			$("#quickviewContentBackground").unbind('click',closeQuickView);	
		} catch (e) {}
	}
}

function closeQuickViewWithFade() {
	$("#quickview").fadeOut(function() {
		closeQuickView();
	});
}
function closeQuickViewWithFadeBORIS() {
	$("#quickview").fadeOut(function() {
		$.modal.close();
		closeQuickView();		
	});
}


function quickViewZoom(args) {
	$("#quickviewContent").css("display", "none");	
	$("#quickviewLoading").css("display", "block");	
	$.post(global_quickViewZoomImagePath,
		args,
		function(data, textStatus) {
			$("#quickviewLoading").css("display", "none");	
			if (textStatus != "success") {
				alert("There was problem loading Zoom Image for this product. Please try back again later.");
				closeQuickViewZoomImage();
			}
			else {
				var imageDiv = '<div id="quickViewZoomImage">' + data + '</div>';
				$("#quickview_middleRight").prepend(imageDiv);
				$("#quickview_bottomRight a").attr("href", "javascript:closeQuickViewZoomImage()").attr("title", "Close Quick View");
			}
		}
	);
}

function closeQuickViewZoomImage() {
	$("#quickviewContent").css("display", "block");
	$("#quickViewZoomImage").remove();	
	$("#quickview_bottomRight a").attr("href", "javascript:closeQuickView()").attr("title", "Close Quick View");
}

/* utility functions */
function getQueryStringFromURL(URLString) {
	var returnObject = {};
	var querystring = URLString.split("?")[1];
	var skuFound = false;
	var model_nbrFound = false;
	var modelFound = false;
	
	// return empty object if there is no query string
	if (!querystring) return null;
	
	// parse query string into object
	// TODO: we might need to check for &amp;
	var querystringArray = querystring.split("&");
	
	$.each(querystringArray, function(i) {
		var key = querystringArray[i].split("=")[0];
		var value = querystringArray[i].split("=")[1];
		
		if (key == 'sku') skuFound = true;
		if (key == 'model_nbr') model_nbrFound = true;
		if (key == 'model') modelFound = true;
		
		if (key) returnObject[key] = value;
	});

	if ((skuFound && model_nbrFound) || modelFound) {
		return returnObject;
	}
	else {
		return null;
	}
}

function getQueryStringFromURLForURLReWrite(URLString) {
	var returnObject = {};
	var skuFound = false;
	var model_nbrFound = false;
	var modelFound = false;
		
	// parse query string into object
	var querystringArray = URLString.split("/");
	
	$.each(querystringArray, function(i) {
		var key = querystringArray[i].split("--")[0];
		var value = querystringArray[i].split("--")[1];
		
		if (key == 'sku') skuFound = true;
		if (key == 'model_nbr') model_nbrFound = true;
		if (key == 'model') modelFound = true;		
		
		if (key) returnObject[key] = value;
	});

	if ((skuFound && model_nbrFound) || modelFound) {
		return returnObject;
	}
	else {
		return null;
	}
}

function getQueryStringFromURLForURLReWriteII(URLString) {
	var returnObject = {};
	var skuFound = false;
	var modelFound = false;
	var trackingVariablesString = "";
	
	// get tracking variables
	if (URLString.indexOf("?") > 0) {
		var urlpartArray = URLString.split("?");
		if (urlpartArray.length == 2) {
			URLString = urlpartArray[0];
			trackingVariablesString = urlpartArray[1];
		}
	}
	
	// parse query string into object
	var querystringArray = URLString.split("/");
	$.each(querystringArray, function(i) {
		var key = querystringArray[i].split(":")[0];
		var value = querystringArray[i].split(":")[1];
		
		if (key == 'model') {
			key = 'model_nbr';
		}

		if (key == 'sku') skuFound = true;
		if (key == 'model_nbr') model_nbrFound = true;
		if (key == 'model') modelFound = true;
				
		if (key) returnObject[key] = value;
	});

	// parse tracking variables
	var trackingVariables = trackingVariablesString.split("&");
	$.each(trackingVariables, function(i) {
		var key = trackingVariables[i].split("=")[0];
		var value = trackingVariables[i].split("=")[1];

		if (key) returnObject[key] = value;
	});

	if ((skuFound && model_nbrFound) || modelFound) {
		return returnObject;
	}
	else {
		return null;
	}
}
function viewMoreOtherStyles() {
	$("#quickviewPDP .otherStyles").css("overflow", "auto");
	$("#quickviewPDP .otherStyles a.more").css("display", "inline");
	$("#quickviewPDP .viewMoreStyles").css("display", "none");
}

function trackQVAddToCartButtonPress() {
    var sku = $('#sku').val();
    var style = QVstyles[sku];
    $('#endecaResultsWrapper,#shoppingcart_container').trigger('trackaddtocart', {
        amount: style[idx_list_price],
        banner: tagMgt.banner,
        discount: style[idx_sale_price],
        item: sku,
        matchback_id: tagMgt.matchback_id,
        page_id: "6",
        quantity: $("#QV_quantity").val()
    });
}

var isValidQVA2C = true;
function validateQuickViewAddToCart(formObj, action) {
	isValidQVA2C = true;
        if (singleStoreDisableAddToCart) {
		isValidQVA2C = false;
		$("#qv_atc_button").trigger("QA_ADDTOCART_ERROR", ["SINGLE_STORE_INVENTORY"]);
		alert(RBM.common.text.singleStoreInStoreOnly);
		return false;
        }

	// TODO: Need to validate for integer.
    if (formObj.qty) {
        if (isNaN($(formObj.qty).val()) || $(formObj.qty).val().length == 0) {
		isValidQVA2C = false;
		$("#qv_atc_button").trigger("QA_ADDTOCART_ERROR", ["INVALID_QUANTITY"]);
            	alert("Please enter a valid quantity.");
            	return false;
        } else if ($(formObj.qty).val() == 0)  {
            if (typeof(calledFromCartSKU) == 'undefined') {
                // We're not calling from the cart, so return an error message.
                // Have to have a quantity to add a new item to cart.
		isValidQVA2C = false;
		$("#qv_atc_button").trigger("QA_ADDTOCART_ERROR", ["INVALID_QUANTITY"]);
                alert("Please enter a valid quantity.");
                return false;
            } else {
                // quantity set to 0; delete lineitem
                shoppingCart.remove($(formObj.theID).val());
                return false;
            }
        }
    }
	
	// if store pickup and no storenumber, launch
	if ((BORISEnabled || shipFromStoreEnabled) && action == "addtocart") {
		if (BORISEnabled && $("#deliveryMethod_storepickup").is(":checked") && $("#qv_storeNumber").val() == 0 && $("#skip").val() != 'skip') {
			launchStorePickupOverlay('quickview', isaQVCallback,0,0);
			return false;
		} else {
			if (formObj.size) {
				var sizeValue = $(formObj.size).val();

				if (sizeValue == "choose") {
					isValidQVA2C = false;
					$("#qv_atc_button").trigger("QA_ADDTOCART_ERROR", ["INVALID_SIZE"]);
					alert("Please select a size.");
					return false;
				} else if (shipFromStoreEnabled) {
					processFulfillmentType (formObj.size);
				}
			}
		}
	} else {
		if (formObj.size && $(formObj.size).val() == "choose") {
			isValidQVA2C = false;
			$("#qv_atc_button").trigger("QA_ADDTOCART_ERROR", ["INVALID_SIZE"]);
			alert("Please select a size.");
			return false;
		}
	}
	
	//hot sku check
	if (formObj.hotsku_quantity_left != null) {
		if (parseInt($(formObj.qty).val()) > parseInt($(formObj.hotsku_quantity_left).val())) {
			isValidQVA2C = false;
			$("#qv_atc_button").trigger("QA_ADDTOCART_ERROR", ["PURCHASE_LIMIT"]);
			alert("Order quantity is limited on this product to " + $(formObj.hot_launch_max_per_order).val() + " per customer.");
			return false;
		}
	}

    trackQVAddToCartButtonPress();

    if (inlineAddToCartEnabled && action == 'addtocart' && (lineID == undefined || lineID == 0 )) {
		// skip mini add to cart if personalizing or protective_packaging or XForYPromo
		var personalized = ($(formObj.personalization).length && $(formObj.personalization).is(":checked"));
		var protective_packaging = ($(formObj.protective_packaging).length && $(formObj.protective_packaging).is(":checked"));
		var hasXYPromo = ($("#hasXYPromo").length && $("#hasXYPromo").val());
		if (personalized == false && protective_packaging == false && hasXYPromo == "false" && (typeof(qvSourcePage) == "undefined" || qvSourcePage != "shoppingCart") ) {
			if (BORISEnabled && $("#deliveryMethod_storepickup").is(":checked")) {
				miniAddToCart.openMiniAddToCart("quickview_product_form", closeQuickViewWithFadeBORIS);
			} else {
				miniAddToCart.openMiniAddToCart("quickview_product_form", closeQuickViewWithFade);
			}
			
			return false;
		}
	}

	return true;
}

function replaceURL (URL, paramName, paramValue) {
	if (typeof URL == "undefined" || URL == null)
		return "";
	
	var URLSeparator = '?';
	var paramSeparator = '=';
	var queryStringDelimSymbol = '&';
	var URLElements = URL.split(URLSeparator);
	var URLPath = "";
	var URLQueryString = "";
	if (URLElements.length == 2) {
		URLPath = URLElements[0];
		URLQueryString = URLElements[1];
	}
	else if (URLElements.length == 1) {
		URLPath = URLElements[0];
	}

	var newQueryString = '';
	var queryStringDelimiter = '';
	if (URLQueryString) {
		var i = 0;
		var queryStringElements = URLQueryString.split(queryStringDelimSymbol);
		for (i=0; i<queryStringElements.length; i++) {
			if(queryStringElements[i].indexOf(paramName) == -1) {
				newQueryString += queryStringDelimiter + queryStringElements[i];
			} else {
				newQueryString += queryStringDelimiter + paramName + paramSeparator + paramValue;
			}
			queryStringDelimiter = queryStringDelimSymbol;
		}
	}
	var newURL = URLPath + URLSeparator + newQueryString;
	return newURL;
}

function isaQVCallback(sku, size, qty, storeNumber, fulfillmentType, storeCostOfGoods){
	$("#sku").val(sku);
	$("#QV_size").val(size);
	$("#QV_quantity").val(qty);
	$("#qv_storeNumber").val(storeNumber);
	$("#qv_fulfillmentType").val(fulfillmentType);
	$("#qv_storeCostOfGoods").val(storeCostOfGoods);
	$("#skip").val('skip');	
	
	switch (fulfillmentType) {
	case "PICKUP_IN_STORE":
	case "SEND_TO_STORE":
		$('#quickview_product_form').attr('action', replaceURL($('#quickview_product_form').attr('action'), 'cm', 'ISA PICKUPHERE'));
		$('#quickviewContent #rawURL').html(replaceURL($('#quickviewContent #rawURL').html(), 'cm', 'ISA PICKUPHERE'));
		break;
	case "SHIP_TO_HOME":
		$('#quickview_product_form').attr('action', replaceURL($('#quickview_product_form').attr('action'), 'cm', 'ISAADDTOCART'));
		$('#quickviewContent #rawURL').html(replaceURL($('#quickviewContent #rawURL').html(), 'cm', 'ISAADDTOCART'));
		break;
	}
	
	$("#quickview_product_form").submit();
}

function displayBackOrderMsg(thisObj, altSku) {
	if ($(thisObj).val() == " " || typeof(thisObj.selectedIndex) == "undefined") {
		var index = 0;
	} else {
		var index = thisObj.selectedIndex - 1;
	}
	if (index == -1) {
		$("#backorderMsg").html("");
	} else {
		var selectedStyle = QVstyles[existy(altSku) ? altSku : $("#sku").val()];
		var sizeAvailability = selectedStyle[idx_sizes][index][availability_index];
		var isBackorderCapable = (selectedStyle[idx_sizes][index][backorder_capable] == "Y");
       	var fulfillmentType = $("#qv_fulfillmentType").val();

		if (isBackorderCapable && sizeAvailability != "" && sizeAvailability != "In Store Only" && fulfillmentType == 'SHIP_TO_HOME') {
			$("#backorderMsg").html(RBM.common.text.backOrderedMessage + " " + sizeAvailability);
		} else {
			$("#backorderMsg").html("");
		}
	} 
}

function processFulfillmentType(sizeObj) {
	var selectedStyle = QVstyles[$("#sku").val()];

	if ($(sizeObj).val() == " " || typeof(sizeObj.selectedIndex) == "undefined") {
		var selectedSizeIndex = 0;
	} else {
		var selectedSizeIndex = sizeObj.selectedIndex - 1;
	}

	if (selectedStyle[idx_sizes][selectedSizeIndex][availability_index] == "In Store Only") {
		$("#qv_fulfillmentType").val("SHIP_FROM_STORE");
	}
}

function listFind(list, item) {
	var listArray = list.split(",");
	for (listIndex in listArray) {
		if (listArray[listIndex] == item) return true;
	}
	return false;
}

var launchSku = "";	
function initializeQVHotLaunchCounter(ps) {
	if (ps) 
		launchSku = ps;
	else
		launchSku = $("#sku").val();
	killQVHotLaunchTimer();
	startQVHotLaunchTimer();
}

function startQVHotLaunchTimer() {
	var shoelaunch_skuList = hot_skus;
	var sku = launchSku;
	var isLaunchSku = shoelaunch_skuList.indexOf(sku) != -1;

	timeToHL -= 1;

	if (!isLaunchSku || timeToHL < 0) {
		// show add to cart and disable timer
		if (isLaunchSku)
			$("#quickview #qv_launch_disclaimer").show();
		else
			$("#quickview #qv_launch_disclaimer").hide();
		$("#quickview #qv_unavailable_for_purchase").hide();
		$("#quickview #pdp_deliveryMethod,#quickviewSubmitButton").show();
		$("#quickview #pdp_calltoorder").show();
		$("#quickview #addToWishlist").show();
		killQVHotLaunchTimer();
		return;
	}

   	if (isLaunchSku && $("#quickview #qv_launch_disclaimer").length == 0) {
		$("#quickview div#qv_info").append("<div id=\"qv_launch_disclaimer\">" + RBM.productLaunch.pdp.disclaimer + "</div>");
   	}

	// hide add to cart and things and start timer
	$("#quickview #qv_launch_disclaimer").show();
	$("#quickview #pdp_deliveryMethod,#quickviewSubmitButton").hide();
	$("#quickview #pdp_calltoorder").hide();
	$("#quickview #addToWishlist").hide();
	$("#quickview #qv_unavailable_for_purchase").show();

	var sec = timeToHL % 60;
	var min = parseInt(timeToHL / 60) % 60;
	var hour = parseInt(timeToHL / (60 * 60));

	$("#quickview #qv_unavailable_for_purchase div").html(hour + " " + RBM.productLaunch.pdp.countdownHours + " " + min + " " + RBM.productLaunch.pdp.countdownMinutes + " " + sec + " " + RBM.productLaunch.pdp.countdownSeconds);

	timerID = setTimeout("startQVHotLaunchTimer()", 1000);
}

function killQVHotLaunchTimer() {
	try {
		clearTimeout(timerID);
	}
	catch(ex) {
		// it wasn't meant to be
	}
}
function initializeQuickview() {
    var URLString;
    var qvImgObject;
    
    	$('a.quickviewEnabled').each(function() {
		
		$(this).wrap('<span class="quickViewButtonWrap"></span>').removeClass('quickviewEnabled').parent('span.quickViewButtonWrap').prepend('<a href="javascript:void(0);" title="Open Quick View" class="quickviewButton button" data-btntype="quickview" data-btnname="searchResults_quickview" onmousedown="openQuickViewWithURL(\'' + $.trim($(this).attr('href')) + '\');"><span></span></a>');
		
		qvImgObject = $('img', this);
	});
    
    $('.quickViewButtonWrap').unbind();
    $('a.quickviewEnabled').wrap('<span class="quickViewButtonWrap"></span>').removeClass('quickviewEnabled').parent('span.quickViewButtonWrap').each( function() {
        qvImgObject = $('img', this);
        URLString = $.trim($(this).attr('href'));
        alert(URLString);
        $(this).prepend('<a href="javascript:void(0);" title="Open Quick View" class="quickviewButton button" data-btntype="quickview" data-btnname="searchResults_quickview" onmousedown="openQuickViewWithURL(\'' + URLString + '\');"><span></span></a>');
 	});

    if(isTouchDevice() && $('.quickViewButtonWrap').length > 0){
    
        $('.quickViewButtonWrap').css('display','block');
        $('.quickViewButtonWrap a img').css('margin-bottom','79px');
        
        var fullURL = window.location.href;
    
        if (fullURL.search("finalscore") >= 0 || fullURL.search("final-score") >= 0) {
            $('.quickviewButton').css('cssText','top: 120px; margin: 0 !important; display: block;');
            $('.block-a').css('height','auto');
            $('.block-a .quickViewButtonWrap a img').css('margin-bottom','55px');
        } else if (fullURL.search("ccs") >= 0) {
            $('.quickviewButton').css('cssText','top: 220px; margin: 0 !important; display: block;');
        } else {
            $('.quickviewButton').css('cssText','top: 196px; margin: 0 !important; display: block;');
        }
        
 	} else {
        $('span.quickViewButtonWrap').hover(function() {
            $(this).children('.quickviewButton').css({
                'width': qvImgObject.width(), 
                'margin-top': qvImgObject.height() - global_quickviewButtonImage.height - global_quickViewButtonBottomMargin, 
                'display': 'inline'
            });
        }, function() {
            $(this).children('.quickviewButton').css('display', 'none');
        });
 	}
    
}

function openQuickView(queryString) {
	closeQuickView();

	if ($.browser.msie && $.browser.version == "6.0")
		$("select").css("visibility", "hidden");

	//Inject quick view wrapper and content framework.
	var tags = '<div id="quickviewContentBackground"></div><div id="qv-wrapper"><div id="quickview"><div id="quickview_top"><div id="quickview_topRight"></div></div><div id="quickview_middle"><div id="quickview_middleRight"><div id="quickviewLoading"></div><div id="quickviewContent"></div><div style="clear: both"></div></div></div><div id="quickview_bottom"><div id="quickview_bottomRight"><a href="javascript:closeQuickView()" title="Close Quick View"><span class="red">x</span> ' + RBM.quickView.button.close + '</a></div></div></div></div>';
	$("body").prepend(tags);
	
	//Display loading graphic
	$("#quickviewLoading").css("display", "block");	
	$("#qv-wrapper").css({ width: global_quickViewWidth });
	$("#quickview").css({ width: global_quickViewWidth });
	
	$("#quickviewContent").load(global_quickViewPDPTemplatePath,
		queryString,
		function (responseText, textStatus, XMLHttpRequest) {
			$("#quickviewLoading").css("display", "none");
			if (textStatus != "success") {
				$("#quickview").remove();
				// for debugging
				$("body").html(responseText);
				alert("There was problem loading Quick View for this product. Please try back again later.");
			}
			else {
				$("#quickview").animate({top: '50%'}, function() {
					if (typeof(quickviewCallbackFunction) == "function")
						quickviewCallbackFunction();
						
						$('#quickview').click(stopPropagationHandler);
						$('body').on('click touchend', '#quickviewContentBackground', function() {
				            closeQuickView();
						});
					}
				);
			}
		}
	);

	if(isTouchDevice()) {
		/* If we are on a touch device we want to set the positions to absolute to prevent odd behaviors */
		/* with form input elements inside other elements with fixed positioning. */
		$("#quickviewContentBackground").css({ margin: '0'});
		$("#qv-wrapper").css({ position: 'absolute', margin: '0' });
		$('#qv-wrapper').center();

        /* add window resize listener */
        $(window).on('resize', function() {
            $('#qv-wrapper').center();
        });

        /* prevent touchmove on mobile device */
        $('#quickviewContentBackground').on('touchmove',function(e) {
	        e.preventDefault();
   		});
	}
}

jQuery.fn.center = function () {
    this.css("top", Math.max(0, (($(window).height() - $(this).outerHeight()) / 2) + $(window).scrollTop()) + "px");
    this.css("left", Math.max(0, (($(window).width() - $(this).outerWidth()) / 2) + $(window).scrollLeft()) + "px");
    return this;
};

function closeQuickView() {
	if ($.browser.msie && $.browser.version == "6.0")
		$("select").css("visibility", "visible");
	
	if ((typeof(BORISEnabled) != "undefined") && BORISEnabled) {
		if (typeof(modal) != "undefined" && $.modal.data.isOpen) {
			return;
		}
	}
	
	$('#quickviewContentBackground, #qv-wrapper').remove();

	if(isTouchDevice()) {
		$(window).off('resize');
	}

	quickViewUnbindBackgroundClose();
}
