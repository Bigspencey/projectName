function SeatPanel(){if(clientSideData.SEATMAP!=undefined){this.smModel=this.convertSeatMap(clientSideData.SEATMAP);this.rp=$.extend(true,{},clientSideData.DEFAULT_RIGHTPANEL_MODEL);this.init();this.listen();$("#SITContent tr td strong[id^=SEAT_]").each(function(){if($.trim($(this).text())!=""){$("#SITAddSeat").trigger("click");}});if(clientSideData.PAGE_CODE=="FSRS"){var atLeastOneSeatSelected=false;$("tbody[id^='SITContent_']").each(function(){var tbody=$(this);var allCharg=true;tbody.find("input[id^='WDS_SEAT_IS_CHARGEABLE_']").each(function(){if(!$(this).val()){allCharg=false;}});tbody.find("input[id^='WDS_SEAT_ASSIGNMENT']").each(function(){if($(this).val()!=""){atLeastOneSeatSelected=true;}});if(allCharg){tbody.find("button[id^='SITChangeButton']").remove();}});if(atLeastOneSeatSelected){$("#SITCancel").remove();}}}}SeatPanel.prototype.init=function(){var seatPanel=this;var initPassengerSeatMap=seatPanel.smModel["passengers"];seatMap.attachPassengers(initPassengerSeatMap);seatMap.setCurrency(rpModel.currencyCode);seatMap.setCloseCallback(function(){seatPanel.removeSeat([0,1],false);});seatMap.setSaveAndCloseCallback(function(){seatPanel.updateSeatPanel();if(clientSideData.PAGE_CODE=="PURF"){var seatForm=wdk.form("ADD_SEATS",{ajaxSubmit:true,ajaxOptions:{dataType:"json",success:function(data){seatPanel.updateRightPanel();$.unblockUI();},error:function(){alert("error while adding seat");$.unblockUI();}},errorPanel:$("#pageError")});$("#SITContent").find("input[id^=WDS_SEAT_ASSIGNMENT_]").each(function(){if($(this).val()!=""){var inputToAdd="<input type='hidden' name='"+$(this).attr("name")+"' value='"+$(this).val()+"'/>";$("#ADD_SEATS").append(inputToAdd);}});$.blockUI();seatForm.submit();}else{seatPanel.updateRightPanel();}});};SeatPanel.prototype.listen=function(){var seatPanel=this;$("#SITAddSeat").on("click",function(){$(this).addClass("none");$("#SITContent").removeClass("none");});$("button[id^=SITConfButton], button[id^=SITChangeButton]").on("click",function(){var idArr=$(this).attr("id").split("_");var boundId=idArr[1];var segmentIndex=idArr[2];var allSegments=[];var effectiveSegmentIndex=~~segmentIndex;for(var bound in seatPanel.smModel.listBound){if(seatPanel.smModel.listBound.hasOwnProperty(bound)){allSegments=allSegments.concat(seatPanel.smModel.listBound[bound]);if(~~bound<~~boundId){effectiveSegmentIndex+=seatPanel.smModel.listBound[bound].length;}}}seatMap.prepare(allSegments);seatMap.show(effectiveSegmentIndex);});$("#SITCancel").on("click",function(){seatPanel.removeSeat([0,1],false);seatMap.attachPassengers(seatPanel.smModel["passengers"]);$("#SITAddSeat").removeClass("none");$("#SITContent").addClass("none");seatPanel.updateRightPanel();});};SeatPanel.prototype.convertSeatMap=function(sm){for(var boundKey in sm.listBound){if(sm.listBound.hasOwnProperty(boundKey)){for(var segmentKey in sm.listBound[boundKey]){if(sm.listBound[boundKey].hasOwnProperty(segmentKey)){for(var flightKey in sm.listBound[boundKey][segmentKey]){if(sm.listBound[boundKey][segmentKey].hasOwnProperty(flightKey)){var flight={};var oldFlight=sm.listBound[boundKey][segmentKey][flightKey];flight["AIRLINE_CODE"]=oldFlight.airlineCode;flight["B_AIRPORT_CODE"]=oldFlight.bAirportCode;flight["B_DATE"]=oldFlight.bDate;flight["B_TIME"]=oldFlight.bTime;flight["BOOKING_CLASS"]=oldFlight.bookingClass;flight["BOUND"]=oldFlight.bound;flight["DATE_LOCATION"]=oldFlight.dateLocation;flight["E_AIRPORT_CODE"]=oldFlight.eAirportCode;flight["E_TIME"]=oldFlight.eTime;flight["EQUIPMENT_NAME"]=oldFlight.equipmentName;flight["EQUIPMENT_TYPE"]=oldFlight.equipmentType;flight["FARE_BASIS"]=oldFlight.fareBasis;flight["FROM"]=oldFlight.from;flight["LANGUAGE"]=oldFlight.language;flight["OUTPUT_TYPE"]=oldFlight.outputType;flight["SITE"]=oldFlight.site;flight["TO"]=oldFlight.to;flight["WDS_MARKET"]=oldFlight.wdsMarket;flight["ONLY_CHARGEABLE_SEATS"]=oldFlight.onlyChargeableSeats;flight["ONLY_FREE_SEATS"]=oldFlight.onlyFreeSeats;flight["LIST_MSG_E"]=oldFlight.listMsgE==null?"FALSE":oldFlight.listMsgE;flight["LIST_MSG_W"]=oldFlight.listMsgW==null?"FALSE":oldFlight.listMsgW;sm.listBound[boundKey][segmentKey][flightKey]=flight;}}}}}}for(var iPassenger=0;iPassenger<sm.passengers.length;iPassenger++){var passenger={};var oldPassenger=sm.passengers[iPassenger];passenger["FIRST_NAME"]=oldPassenger.firstName;passenger["LAST_NAME"]=oldPassenger.lastName;passenger["HAS_INFANT"]=oldPassenger.hasInfant;passenger["TITLE"]=oldPassenger.title;passenger["TRAVELLER_ID"]=oldPassenger.travellerId;passenger["TRAVELLER_TYPE"]=oldPassenger.travellerType;var infant={};var oldInfant=oldPassenger.infant;infant["FIRST_NAME"]=oldInfant.firstName;infant["LAST_NAME"]=oldInfant.lastName;infant["TITLE"]=oldInfant.title;infant["TRAVELLER_ID"]=oldInfant.travellerId;infant["TRAVELLER_TYPE"]=oldInfant.travellerType;passenger["INFANT"]=infant;passenger["RESERVATION"]={};for(var key in oldPassenger.reservation){if(oldPassenger.reservation.hasOwnProperty(key)){var reservation={};var oldReservation=oldPassenger.reservation[key];reservation["BOUND_ID"]=oldReservation.boundId;reservation["PRICE"]=oldReservation.price;reservation["SEAT"]=oldReservation.seat;reservation["SEAT_READONLY"]=oldReservation.seatReadOnly;reservation["SEAT_TYPE"]=oldReservation.seatType;passenger["RESERVATION"][key]=reservation;}}sm.passengers[iPassenger]=passenger;}return sm;};SeatPanel.prototype.chargeableSeatsTermsAndConditionsPopin=function(successCallback){if(this.areAnyChargeableSeatsSelected()){seatMap.chargeableSeatsPopin(successCallback);}else{successCallback();}};SeatPanel.prototype.areAnyChargeableSeatsSelected=function(){var result=false;$("tbody[id^='SITContent_']").each(function(){var tbody=$(this);tbody.find("input[id^='WDS_SEAT_IS_CHARGEABLE_']").each(function(){if("TRUE"===$(this).val()){var chargeableId=$(this)[0].id;var assignmentId=chargeableId.replace("WDS_SEAT_IS_CHARGEABLE","WDS_SEAT_ASSIGNMENT");tbody.find("input#"+assignmentId).each(function(){if(""!==$(this).val()){result=true;return;}});}});});return result;};SeatPanel.prototype.updateSeatPanel=function(takeFromInitialSetForBound){$("button[id^=SITChangeButton]").addClass("none");$("button[id^=SITConfButton]").removeClass("none");if(clientSideData.PAGE_CODE=="FSRS"){fsrsController.hidePaymentPanelIfPaymentNotReqAndNoXbags();}var seatSelection=seatMap.getSeats();if(typeof takeFromInitialSetForBound==="number"&&takeFromInitialSetForBound%1==0){var initialSeatSelection=seatMap.getInitialSeats();for(var pas in seatSelection){if(seatSelection.hasOwnProperty(pas)){for(var flight in seatSelection[pas].RESERVATION){for(var flight in seatSelection[pas].RESERVATION){if(seatSelection[pas].RESERVATION.hasOwnProperty(flight)){var flightInfo=seatSelection[pas].RESERVATION[flight];if(flightInfo.BOUND_ID==takeFromInitialSetForBound&&typeof flightInfo.PRICE!=="undefined"&&typeof initialSeatSelection[pas]!=="undefined"&&initialSeatSelection[pas].RESERVATION!=="undefined"&&initialSeatSelection[pas].RESERVATION[flight]!=="undefined"){seatSelection[pas].RESERVATION[flight]=initialSeatSelection[pas].RESERVATION[flight];}}}}}}}var totalPrice=0;for(var pas in seatSelection){if(seatSelection.hasOwnProperty(pas)){var travellerId=seatSelection[pas].TRAVELLER_ID;for(var flight in seatSelection[pas].RESERVATION){if(seatSelection[pas].RESERVATION.hasOwnProperty(flight)){var seatHtml=$("#SEAT_"+travellerId+"_"+flight);if(seatSelection[pas].RESERVATION[flight].SEAT!=""){seatHtml.html(seatSelection[pas].RESERVATION[flight].SEAT);if(typeof seatSelection[pas].RESERVATION[flight].SEAT_READONLY!=="undefined"&&seatSelection[pas].RESERVATION[flight].SEAT_READONLY){seatHtml.parents("td").find("input[id^=WDS_SEAT_ASSIGNMENT_]").val("");}else{seatHtml.parents("td").find("input[id^=WDS_SEAT_ASSIGNMENT_]").val(seatSelection[pas].RESERVATION[flight].SEAT);if(clientSideData.PAGE_CODE=="FSRS"){if(typeof(fsrsController)!="undefined"){fsrsController.setSeatChange();}}}var tbody=seatHtml.parents("tbody");tbody.find("button[id^=SITChangeButton]").removeClass("none");tbody.find("button[id^=SITConfButton]").addClass("none");var em=seatHtml.next("em");if(seatSelection[pas].RESERVATION[flight].SEAT_TYPE!=undefined){em.html(clientMessages[clientSideData.PAGE_CODE+".text.ChargeableSeats."+seatSelection[pas].RESERVATION[flight].SEAT_TYPE+"Seat"]).removeClass("none");seatHtml.parent("td").find("input[id^=WDS_SEAT_IS_CHARGEABLE_]").prop("disabled",false);seatHtml.parent("td").find("input[id^=WDS_SEAT_IS_CHARGEABLE_]").val("TRUE");}else{if(!em.hasClass("none")){em.addClass("none");}seatHtml.parent("td").find("input[id^=WDS_SEAT_IS_CHARGEABLE_]").prop("disabled",true);seatHtml.parent("td").find("input[id^=WDS_SEAT_IS_CHARGEABLE_]").val("FALSE");}var priceDom=$("#PRICE_"+travellerId+"_"+flight);if(typeof seatSelection[pas].RESERVATION[flight].SEAT_READONLY!=="undefined"&&seatSelection[pas].RESERVATION[flight].SEAT_READONLY){priceDom.html(clientMessages["FSR.text.ChargeableSeats.AlreadyPaid"]);}else{if(seatSelection[pas].RESERVATION[flight].PRICE!=void (0)){var price=seatSelection[pas].RESERVATION[flight].PRICE;if(price!=""&&price!=0){priceDom.html(theUtils.formatPrice(price));totalPrice+=theUtils.getLocalIndependetAmount(price);seatHtml.parents("td").find("input[id^=SEATPRICE_]").val(price);}else{priceDom.html("&nbsp;");}}else{priceDom.html("&nbsp;");}}}}}}}var totalDom=$("#SITTotal .price");var cancelButton=$("#SITCancel");var isCorporateFlow=clientSideData.IS_CORPORATE_SALES_FLOW;var payLaterAvailable=false;var mopLabel=null;var mopId="";$("fieldset label").each(function(){var target=$(this);var attrVal=target.attr("data-mopname");if(attrVal!=""&&attrVal=="PayLater"){payLaterAvailable=true;mopLabel=target;mopId=target.attr("id").substr(1);}});if(totalPrice>0){totalDom.html(theUtils.formatPrice(totalPrice));totalDom.parent().removeClass("none");cancelButton.removeClass("none");if(clientSideData.PAGE_CODE=="PURF"&&isCorporateFlow&&payLaterAvailable){mopLabel.addClass("inactive");$("#payLaterWarning").show();$("#payLaterInfo").hide();}}else{if(!totalDom.parent().hasClass("none")){totalDom.parent().addClass("none");}if(!cancelButton.hasClass("none")){cancelButton.addClass("none");}if(clientSideData.PAGE_CODE=="PURF"&&isCorporateFlow&&payLaterAvailable){mopLabel.removeClass("inactive");$("#payLaterWarning").hide();$("#payLaterInfo").show();}}if(clientSideData.PAGE_CODE=="FSRS"){if(totalPrice>0){fsrsController.showPaymentPanel();}else{fsrsController.hidePaymentPanelIfPaymentNotReqAndNoXbags();}}};SeatPanel.prototype.updateRightPanel=function(){var seatPanel=this;var priceExit=[0,0];var countExit=[0,0];var priceXL=[0,0];var countXL=[0,0];var seatSelection=seatMap.getSeats();for(var pas in seatSelection){if(seatSelection.hasOwnProperty(pas)){for(var flight in seatSelection[pas].RESERVATION){if(seatSelection[pas].RESERVATION.hasOwnProperty(flight)){if(seatSelection[pas].RESERVATION[flight].PRICE!=void (0)){var price=theUtils.getLocalIndependetAmount(seatSelection[pas].RESERVATION[flight].PRICE);var boundId;if(clientSideData.PAGE_CODE!="FSRS"){boundId=seatSelection[pas].RESERVATION[flight].BOUND_ID;}else{boundId=this.getBoundId(seatSelection[pas].RESERVATION[flight].BOUND_ID);}if(!isNaN(price)&&price!=""&&price!=0&&(typeof seatSelection[pas].RESERVATION[flight].SEAT_READONLY==="undefined"||!seatSelection[pas].RESERVATION[flight].SEAT_READONLY)){if(seatSelection[pas].RESERVATION[flight].SEAT_TYPE=="XL"){priceXL[boundId]+=price;countXL[boundId]++;}else{priceExit[boundId]+=price;countExit[boundId]++;}}}}}}}var temp=seatPanel.rp;var allBounds=[];for(var i=0;i<2;i++){var data={};data.boundId=i;if(countExit[i]>0||countXL[i]>0){var listSeats=[];if(countExit[i]>0){var seatExit={};seatExit.count=countExit[i];seatExit.type="EXIT";seatExit.price=priceExit[i];listSeats.push(seatExit);}if(countXL[i]>0){var seatXL={};seatXL.count=countXL[i];seatXL.type="XL";seatXL.price=priceXL[i];listSeats.push(seatXL);}data.seatsInfo={};if(typeof temp.bounds[i]!=="undefined"&&typeof temp.bounds[i].seatsInfo!=="undefined"){data.seatsInfo=$.extend(temp.bounds[i].seatsInfo,{});data.seatsInfo.seats=listSeats;}else{data.seatsInfo.seats=listSeats;}data.seatsInfo.popinCallback=function(event){var boundId=event.data.boundId;var itemId=event.data.itemId;seatPanel.removeSeat([itemId],[boundId],true);var params={boundId:boundId};seatPanel.updateSeatPanel(boundId);$(document).trigger("removeAddedSeats",params);};$(document).trigger("updateSeats",data);allBounds.push(data);}else{$(document).trigger("removeSeats",data);if(clientSideData.PAGE_CODE=="FSRS"){var temp=clientSideData.DEFAULT_RIGHTPANEL_MODEL;if(typeof temp.bounds!=="undefined"){for(var key in temp.bounds){if(temp.bounds.hasOwnProperty(key)){if(key==i&&typeof temp.bounds[key].seatsInfo!=="undefined"){$(document).trigger("updateSeats",{"boundId":temp.bounds[key].boundId,"seatsInfo":temp.bounds[key].seatsInfo});allBounds.push({"boundId":temp.bounds[key].boundId,"seatsInfo":temp.bounds[key].seatsInfo});}}}}}}}$(document).trigger("updateSeatsAll",{"details":allBounds});};SeatPanel.prototype.getBoundId=function(itemId){var seatPanel=this;var tempRp=seatPanel.rp;for(var i=0;i<tempRp.bounds.length;i++){if(tempRp.bounds[i].itemId==itemId){return i;}}return 0;};SeatPanel.prototype.removeSeat=function(itemIds,onlyChargeable){$("[id^=SITContent_] tr").each(function(){var target=$(this);if(target.find("input[id^=WDS_SEAT_PREV_SELECTED_]").length==0||target.find("input[id^=WDS_SEAT_PREV_SELECTED_]").val()!=="true"){target.find("[id^=SEAT_], [id^=PRICE_], .seatType").text("");target.find("input[id^=WDS_SEAT_ASSIGNMENT_]").val("");target.find("input[id^=WDS_SEAT_IS_CHARGEABLE_]").val("").prop("disabled",true);target.find("input[id^=SEATPRICE_]").val("");}});for(var i in itemIds){var data={};data.boundId=itemIds[i];$(document).trigger("removeSeat",data);}$("#SITTotal").addClass("none");if(clientSideData.PAGE_CODE=="FSRS"){fsrsController.hidePaymentPanelIfNoXbags();}};$(function(){window.theSeatPanel=new SeatPanel();});