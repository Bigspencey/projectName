function LuggagePanel(){this.listen();this.init();}LuggagePanel.prototype.init=function(){this.preselectExistingLuggage();$("[id^='SELECT_XBAG_']").on("change",function(){var splitedId=$(this).parents("tbody").attr("id").split("_");$("#XBAGConfButton_"+splitedId[1]+"_"+splitedId[2]).show();});$("[id^='XBAGConfButton_']:visible").hide();};LuggagePanel.prototype.getPriceForSelectedXbag=function(self,itemId,passengerId){var luggagePanel=this;var price=luggagePanel.getLuggagePrice(itemId,passengerId,self.val());if(clientSideData.PAGE_CODE=="FSRS"){if(jQuery.isNumeric(theUtils.getLocalIndependetAmount(price))){var orginalOption=self.find("option[value='primeSelected']");var orginal=0;var orginalSSR=0;var currentSSR=~~self.val();if(orginalOption.length>0){orginal=luggagePanel.getLuggagePrice(itemId,passengerId,orginalOption.data("preselected"));orginalSSR=~~orginalOption.data("preselected");}currentSSR-=~~orginalSSR;var available;if(clientSideData.LIST_SERVICES.XBAG.GLBL_PARAM_TO_USE.IS_WEIGHT_OR_UNIT=="WEIGHT"){available=clientSideData.LIST_SERVICES.XBAG.GLBL_PARAM_TO_USE.WDS_AVAILABLE_WEIGHT;}else{available=[];for(var i=1;i<=clientSideData.LIST_SERVICES.XBAG.GLBL_PARAM_TO_USE.WDS_AVAILABLE_PIECE_LIMIT;i++){available[available.length]=i;}}available.sort(function(a,b){return a-b;});var partialSSR=true;for(i=0;i<available.length;i++){var current=available[i];if(currentSSR==current&&i!=0){break;}if(currentSSR<current){partialSSR=false;break;}}if(partialSSR){price=theUtils.getLocalIndependetAmount(price);var possiblePrices=luggagePanel.getPossiblePrices(itemId,passengerId,self.val());var isFound=false;if(clientSideData.LIST_SERVICES.XBAG_FSRS!=undefined){$.each(clientSideData.LIST_SERVICES.XBAG.REQUESTED_PRICE[itemId],function(){if(clientSideData.XBAG_FSRS.BOUNDS[itemId-1].PASSENGERS[passengerId-1].UNIT=="KG"){$.each(this,function(){if(parseFloat(this.REQUESTED_VALUE)+parseFloat(clientSideData.XBAG_FSRS.BOUNDS[itemId-1].PASSENGERS[passengerId-1].WEIGHT)>=parseFloat($(self).val())&&isFound==false){price=clientSideData.XBAG_FSRS.BOUNDS[itemId-1].PASSENGERS[passengerId-1].PRICE+this.SERVICE_PRICE;isFound=true;return;}});}if(isFound==true){return;}});}else{for(var key in possiblePrices){if(possiblePrices.hasOwnProperty(key)){if(price-0.01<=possiblePrices[key]&&price+0.01>=possiblePrices[key]){price=possiblePrices[key];break;}}}}price=theUtils.formatPrice(price);}}}return price;};LuggagePanel.prototype.preselectExistingLuggage=function(){var i=0;var ids=[];var pressed=false;for(var key in clientSideData.LIST_SELECTED_SERVICES.XBAG){ids=[];if(clientSideData.LIST_SELECTED_SERVICES.XBAG[key]!="NO_LUGGAGE"){if(!pressed){$("#XBAGAddLuggage").click();pressed=true;}ids=$("button[id^='XBAGConfButton_']").eq(i).attr("id").split("_");this.addLuggage(ids[1],ids[2]);}i++;}if(clientSideData.PAGE_CODE=="FSRS"){$("select:not(:has(option))").each(function(){$(this).selectBox("control").addClass("none");var selfIdAr=$(this).attr("id").split("_");var passengerId=selfIdAr[3];var boundIndex=selfIdAr[4]-1;if(typeof clientSideData.LIST_SELECTED_SERVICES!=="undefined"&&typeof clientSideData.LIST_SELECTED_SERVICES.XBAG!=="undefined"&&typeof clientSideData.LIST_SELECTED_SERVICES.XBAG[boundIndex]!=="undefined"&&typeof clientSideData.LIST_SELECTED_SERVICES.XBAG[boundIndex][passengerId]!=="undefined"){var unit;}if(clientSideData.LIST_SERVICES.XBAG.GLBL_PARAM_TO_USE.IS_WEIGHT_OR_UNIT=="WEIGHT"){unit=clientMessages["FSRS.text.Luggage.CurrencyWeight.Kilo"];}else{unit=clientMessages["FSRS.text.Luggage.CurrencyPieces"];}var span=$("<span>"+clientSideData.LIST_SELECTED_SERVICES.XBAG[boundIndex][passengerId]+unit+"</span>");$(this).after(span);});}};LuggagePanel.prototype.listen=function(){var luggagePanel=this;$("#XBAGAddLuggage").on("click",function(){$(this).addClass("none");$("#XBAGContent").removeClass("none");luggagePanel.setSbs();$("select.luggage-item").change();});$("select.luggage-item").on("change",function(){var self=$(this);var selfIdAr=self.attr("id").split("_");var passengerId=selfIdAr[3];var itemId=selfIdAr[4];var price=luggagePanel.getPriceForSelectedXbag($(this),itemId,passengerId);if(price==undefined){price=0;}var bagPrice=theUtils.getLocalIndependetAmount(price);self.parents("td").next().html(price+"&nbsp;"+"<input type='hidden' value="+bagPrice+" name='XBAGPRICE_"+passengerId+"_"+itemId+"' id='XBAGPRICE_"+passengerId+"_"+itemId+"' />");self.parents("label").next().html(self.find("option[value="+self.val()+"]").html());});$("select.luggage-item").change();$("button[id^='XBAGConfButton_']").on("click",function(){var self=$(this);var selfIdAr=self.attr("id").split("_");var itemId=selfIdAr[1];var boundId=selfIdAr[2];luggagePanel.addLuggage(itemId,boundId);var box=$(this).parents("tbody[id^='XBAGContent_']");if(box.find("a.selectBox:visible").length==0){box.find("tr.caption.boxw output").removeClass("none");}});$("button[id^='XBAGChangeButton_']").on("click",function(){$(this).parents("tbody[id^='XBAGContent_']").find("tr.caption.boxw output").addClass("none");var self=$(this);var selfIdAr=self.attr("id").split("_");var itemId=selfIdAr[1];var boundId=selfIdAr[2];luggagePanel.removeLuggage([itemId],[boundId],false);});$("button#XBAGCancel").on("click",function(){$("[id^=XBAGContent_]").each(function(){var self=$(this);var itemId=self.attr("id").split("_")[1];var boundId=self.attr("id").split("_")[2];luggagePanel.removeLuggage([itemId],[boundId],true);});$("#XBAGAddLuggage").removeClass("none");$("#XBAGContent").addClass("none");$("#XBAGContent").find("tr.caption output").addClass("none");luggagePanel.destroySbs();if(clientSideData.PAGE_CODE=="FSRS"){fsrsController.hidePaymentPanelIfNoSeats();}});wdk.form("FSR_FORM",{errorPanel:$("#pageError"),check:function(){$.unblockUI();},prepareSubmit:function(){$.blockUI();$("select").prop("disabled",true);}});};LuggagePanel.prototype.setSbs=function(){$("select.luggage-item").each(function(){var self=$(this);if(self.find("option").size()>1){self.selectBox();}else{var label=self.parents("label");self.remove();label.next().removeClass("none");}});};LuggagePanel.prototype.destroySbs=function(){$("select.luggage-item").selectBox("destroy").find("option:first").prop("selected",true);};LuggagePanel.prototype.getLuggagePrice=function(itemId,passengerId,val){if(val=="default"){return"";}if(val=="primeSelected"||typeof val==="undefined"||val==null){return clientMessages[clientSideData.PAGE_CODE+".text.Luggage.AlreadyPaid"];}return theUtils.formatPrice(clientSideData.LIST_SERVICES.XBAG.REQUESTED_PRICE[itemId][passengerId][val].SERVICE_PRICE);};LuggagePanel.prototype.getPossiblePrices=function(itemId,passengerId,val){if(val=="default"||val=="primeSelected"||typeof val==="undefined"||val==null){return undefined;}var ret=[];var pricesOb=clientSideData.LIST_SERVICES.XBAG.REQUESTED_PRICE[itemId][passengerId];for(var key in pricesOb){if(pricesOb.hasOwnProperty(key)){ret[ret.length]=pricesOb[key].SERVICE_PRICE;}}return ret;};LuggagePanel.prototype.addLuggage=function(itemId,boundId){var luggagePanel=this;var data={};data.boundId=boundId;var luggage={};luggage.count=0;luggage.label=clientMessages["ALLP.text.Luggage"];luggage.price=0;var listPassengers=[];$("#XBAGContent_"+itemId+"_"+boundId+" select.luggage-item").each(function(){var self=$(this);var selfIdAr=self.attr("id").split("_");var passengerId=selfIdAr[3];var passenger={};var price=luggagePanel.getPriceForSelectedXbag($(this),itemId,passengerId);if(price!=""&&self.val()!="primeSelected"&&self.val()!==null){passenger.name=self.parents("td").prev().html();var tmpAmount=~~self.find("option[value="+self.val()+"]").val();var unit=self.find("option[value="+self.val()+"]").data("unit");if(self.find("option[value='primeSelected']").length>0){tmpAmount-=~~self.find("option[value='primeSelected']").data("preselected");}passenger.travellerID=passengerId;passenger.amount=tmpAmount+" "+unit;luggage.price+=theUtils.getLocalIndependetAmount(price);luggage.count++;passenger.price=theUtils.getLocalIndependetAmount(price);listPassengers.push(passenger);self.parents("label").find("input").val(self.val());}});if(luggage.price!=0){luggage.passengers=listPassengers;}if(luggage.count>0){var label=$("#XBAGContent_"+itemId+"_"+boundId).find("label");label.addClass("none");label.next().removeClass("none");$("#XBAGConfButton_"+itemId+"_"+boundId).addClass("none");$("#XBAGChangeButton_"+itemId+"_"+boundId).removeClass("none");}if(luggage.count>1){luggage.label=clientMessages["ALLP.text.Luggages"];}luggage.popinCallback=function(event){var boundId=event.data.boundId;var itemId=event.data.itemId;$("#XBAGChangeButton_"+itemId+"_"+boundId).trigger("click");};if(luggage.count>0){if(clientSideData.PAGE_CODE=="FSRS"){data.luggage={};data.luggage.addedLuggage=luggage;var confirmedLuggage=luggagePanel.getConfirmedLuggage(boundId);if(confirmedLuggage!=null){data.luggage.confirmedLuggage=confirmedLuggage;}}else{data.luggage=luggage;}}$(document).trigger("updateLuggage",data);luggagePanel.updateTotalPrice($("#XBAGTotal"),$("#XBAGContent .servicePrice"),$("#XBAGCancel"),clientSideData.PAGE_CODE+".text.Luggage.Total");};LuggagePanel.prototype.getConfirmedLuggage=function(boundId){if(clientSideData.DEFAULT_RIGHTPANEL_MODEL!=undefined){var temp=clientSideData.DEFAULT_RIGHTPANEL_MODEL;if(temp["bounds"][boundId]!=undefined&&temp["bounds"][boundId].luggage!=undefined&&temp["bounds"][boundId].luggage.confirmedLuggage!=undefined){return temp["bounds"][boundId].luggage.confirmedLuggage;}}return null;};LuggagePanel.prototype.removeLuggage=function(itemIds,boundId,reset){var luggagePanel=this;if(reset===undefined){reset=false;}for(var i in itemIds){$("#XBAGContent_"+itemIds[i]+"_"+boundId[i]+" select.luggage-item").each(function(){var select=$(this);var label=select.parents("label");label.removeClass("none");label.next().addClass("none");label.find("a.selectBox").selectBox("refresh");if(reset){select.parents("td").next().html("&nbsp;");}select.parents("label").find("input").val("");});$("#XBAGChangeButton_"+itemIds[i]+"_"+boundId[i]).addClass("none");$("#XBAGConfButton_"+itemIds[i]+"_"+boundId[i]).removeClass("none");var data={};data.boundId=boundId[i];$(document).trigger("removeLuggage",data);if(clientSideData.PAGE_CODE=="FSRS"){var confirmedLuggage=luggagePanel.getConfirmedLuggage(boundId[i]);if(confirmedLuggage!=null){data.luggage={};data.luggage.confirmedLuggage=confirmedLuggage;$(document).trigger("updateLuggage",data);}}}luggagePanel.updateTotalPrice($("#XBAGTotal"),$("#XBAGContent .servicePrice"),$("#XBAGCancel"),clientSideData.PAGE_CODE+".text.Luggage.Total");};LuggagePanel.prototype.updateTotalPrice=function(target,content,cancelButton,totalResourceName){var price=0;content.filter(function(index){return $(this).prev("td").find("label").hasClass("none");}).each(function(){var self=$(this);if($.trim(self.text())!=""){if(!isNaN(parseFloat(self.text()))){price+=theUtils.getLocalIndependetAmount(self.text());}}});if(price>0){target.html(clientMessages[totalResourceName]+"&nbsp;"+"<strong class='price'>"+theUtils.formatPrice(price))+"</strong>";target.removeClass("none");cancelButton.removeClass("none");}else{if(!target.hasClass("none")){target.addClass("none");}if(!cancelButton.hasClass("none")){cancelButton.addClass("none");}}};$(function(){window.theLuggagePanel=new LuggagePanel();});