function LateLogin(){this.init();}LateLogin.prototype.init=function(){this.LATE_LOGIN_FORM=$("#LATE_LOGIN_FORM");this.WDS_LATE_LOGIN_FORM=$("#WDS_LATE_LOGIN_FORM");this.WDS_LOGOUT_FORM=$("#WDS_LOGOUT_FORM");this.WDS_SEARCH_FORM=$("#SEARCH_FORM");this.WDS_REDEMPTION_FORM=$("#WDS_REDEMPTION_FORM");$(".tam-header-bar").on("click","#goToMyBookingList",function(){$("form[name='BOOKING_LIST_FORM']").submit();});var self=this;$("#logginButton2, #logginButton1").click(function(){var error=false;$("#pageErrorLogin").errorPanel("reset");$("#uiInputLogin").parents("article").removeClass("loginError");$("#uiInputLogin").prop("placeholder",clientMessages["ALLP.text.lateLogin.numberPlaceholder"]);$("#uiInputPassword").prop("placeholder",clientMessages["ALLP.text.lateLogin.passwordPlaceholder"]);$("#uiInputLogin").removeClass("bc");$(".head-profile").removeClass("bc");$(".tam-header-login-input-num-wrapper").removeClass("bc");$("#uiInputPassword").removeClass("bc");$(".head-lock").removeClass("bc");$(".tam-header-login-input-pass-wrapper").removeClass("bc");$("#LATE_LOGIN_USERNAME").val($("input[id='uiInputLogin']").filter(":visible").val());$("#LATE_LOGIN_PASSWORD").val($("input[id='uiInputPassword']").filter(":visible").val());if($("#LATE_LOGIN_USERNAME").val()===""){error=true;$("#uiInputLogin").addClass("bc");$(".head-profile").addClass("bc");$(".tam-header-login-input-num-wrapper").addClass("bc");$("#uiInputLogin").prop("placeholder",clientMessages["ALLP.error.LateLogin.MessageMemberIdMandatory"]);}if($("#LATE_LOGIN_PASSWORD").val()===""){error=true;$("#uiInputPassword").addClass("bc");$(".head-lock").addClass("bc");$(".tam-header-login-input-pass-wrapper").addClass("bc");$("#uiInputPassword").prop("placeholder",clientMessages["ALLP.error.LateLogin.MessagePasswordMandatory"]);}if(error){if($("#pageErrorLogin:visible").length>0){$(window).scrollTop();}return false;}$.blockUI();self.callLogin();$.unblockUI();return false;});$(".forgotPassword").click(function(){window.open(clientSideData.WEBAPP_LINKS.FORGOTTEN_PASSWORD_URL,"login","heigh=550,width=420",true);});$(".forgotUsername").click(function(){window.open(clientSideData.WEBAPP_LINKS.FORGOTTEN_USERNAME_URL,"login","height=550,width=420",true);});};LateLogin.prototype.doLateLogin=function(){$("#loginLoadingState").removeClass("none").addClass("active");$("#loginKnownNotLoggedState").removeClass("active").addClass("none");$("#loginNotLoggedState").removeClass("active").addClass("none");$("#loginLoggedState").removeClass("active").addClass("none");var self=this;$.ajax({url:self.WDS_LATE_LOGIN_FORM.attr("action"),data:self.WDS_LATE_LOGIN_FORM.serialize(),type:"post",dataType:"json",success:function(data){$.blockUI();if(data.mapDataUI.LOGIN_INFORMATION!=undefined){self.fillLoginPanel(data);var cachedLoginInfoObject={};cachedLoginInfoObject.TITLE_1=data.mapDataUI.LOGIN_INFORMATION.TITLE_1;cachedLoginInfoObject.FIRST_NAME_1=data.mapDataUI.LOGIN_INFORMATION.FIRST_NAME_1;cachedLoginInfoObject.LAST_NAME_1=data.mapDataUI.LOGIN_INFORMATION.LAST_NAME_1;cachedLoginInfoObject.FREQ_NUMBER_1_1=data.mapDataUI.LOGIN_INFORMATION.FREQ_NUMBER_1_1;$.jStorage.set("cachedLoginInfoObject",cachedLoginInfoObject);var pageCode=clientSideData.PAGE_CODE;if(pageCode=="ALPI"){$("#alpiLoginPanel").remove();$("#alpiLoginTeaser").remove();}if(clientSideData["PAGE_CODE"]=="UPSL"){clientSideData.LOGIN_INFORMATION=data.mapDataUI.LOGIN_INFORMATION;if(data.mapDataUI.SHOW_REDEMPTION_LINK){$("#redemptionLink").html(template_switchToRedemptionLoggedIn.template);$("#redemptionLink").removeClass("none");theCoUpslPage.initRedemptionLink();}else{$("#redemptionLink").addClass("none");}}else{if(clientSideData["PAGE_CODE"]=="RD_MO_CALD"){clientSideData.LOGIN_INFORMATION=data.mapDataUI.LOGIN_INFORMATION;}}if(!((typeof data.mapDataUI.LOGIN_INFORMATION.WDS_CONTACT_MOBILES!=="undefined"&&data.mapDataUI.LOGIN_INFORMATION.WDS_CONTACT_MOBILES!="")||(typeof data.mapDataUI.LOGIN_INFORMATION.WDS_CONTACT_PHONES!=="undefined"&&data.mapDataUI.LOGIN_INFORMATION.WDS_CONTACT_PHONES!=""))){$("#pageErrorLogin").errorPanel();$("#pageErrorLogin").errorPanel("addError",null,null,clientMessages["ALLP.error.LateLogin.PleaseAddPhoneNumbersToProfile"]);}}else{$("#pageErrorLogin").errorPanel();$("#pageErrorLogin").errorPanel("addError",null,null,clientMessages["ALLP.error.LateLogin.41"]);}$("#loginLoadingState").removeClass("active").addClass("none");$("#logoutLink").removeClass("none");if(window.alpi){alpi.initMainPax();}$.unblockUI();},error:function(XHR,textStatus,errorThrown){$("#loginLoadingState").removeClass("active").addClass("none");$.unblockUI();}});};LateLogin.prototype.fillLoginPanel=function(data){clientSideData["LOGIN_INFORMATION"]=data.mapDataUI.LOGIN_INFORMATION;var configLateLogin=[{"ALLP_text_lateLogin_HELLO":clientMessages["ALLP.text.lateLogin.HELLO"],"firstName":data.mapDataUI.LOGIN_INFORMATION.FIRST_NAME_1,"lastName":data.mapDataUI.LOGIN_INFORMATION.LAST_NAME_1,"ALLP_text_lateLogin_youHave":clientMessages["ALLP.text.lateLogin.youHave"],"civility":data.mapDataUI.LOGIN_INFORMATION.TITLE_1,"miles":data.mapDataUI.LOGIN_INFORMATION.FREQ_MILES_1_1,"ALLP_text_lateLogin_pts":clientMessages["ALLP.text.lateLogin.pts"]}];$("#loginLoggedState").replaceWith($("#views_air_common_templates_latelogin_logged").tmpl(configLateLogin));var tierImageLink=data.mapDataUI.LOGIN_INFORMATION.TIER_LEVEL_IMAGE;if(!tierImageLink.match(/^http/)){tierImageLink=clientSideData.WDS_WEBAPP_URL+"/cui-tam_25.76_280615/air/skin/tam/desktop/img/"+tierImageLink;}var configLogPanel=[{"ALLP_text_lateLogin_ACCOUNT":clientMessages["ALLP.text.lateLogin.ACCOUNT"],"freqNumber":data.mapDataUI.LOGIN_INFORMATION.FREQ_NUMBER_1_1,"ALLP_text_lateLogin_FidelidadeProgram":clientMessages["ALLP.text.lateLogin.FidelidadeProgram"],"tierImage":tierImageLink,"DISPLAY_LOGOUT_LINK":clientSideData["DISPLAY_LOGOUT_LINK"],"WDS_DISABLE_BKGL":clientSideData["WDS_DISABLE_BKGL"],"ALLP_text_lateLogin_LOGOUT":clientMessages["ALLP.text.lateLogin.LOGOUT"],"ALLP_text_myBookingListLink":clientMessages["ALLP.text.myBookingListLink"]}];$("#logpanel").replaceWith($("#views_air_common_templates_latelogin_logpanel").tmpl(configLogPanel));$("#loginKnownNotLoggedState").removeClass("active").addClass("none");$("#loginLoggedState").removeClass("none").addClass("active");var pageCode=clientSideData.PAGE_CODE;if(pageCode=="ALPI"){if(!this.isAlpiFormChanged()){$("select[name='TITLE_1']").val(data.mapDataUI.LOGIN_INFORMATION.TITLE_1).selectBox("refresh");$("input[name='FIRST_NAME_1']").val(data.mapDataUI.LOGIN_INFORMATION.FIRST_NAME_1);$("input[name='LAST_NAME_1']").val(data.mapDataUI.LOGIN_INFORMATION.LAST_NAME_1);$("select[name='FREQ_AIRLINE_1']").val("JJ").selectBox("refresh");$("input[name='FREQ_NUMBER_1']").val(data.mapDataUI.LOGIN_INFORMATION.FREQ_NUMBER_1_1);if(typeof data.mapDataUI.LOGIN_INFORMATION.DATE_OF_BIRTH_1!=="undefined"&&data.mapDataUI.LOGIN_INFORMATION.DATE_OF_BIRTH_1!==""){var dateOB=data.mapDataUI.LOGIN_INFORMATION.DATE_OF_BIRTH_1;var year=dateOB.substr(0,4);var month=dateOB.substr(4,2);var day=dateOB.substr(6,2);$("select[name='DATE_OF_BIRTH_DAY_1']").val(day).selectBox("refresh");$("select[name='DATE_OF_BIRTH_MONTH_1']").val(month).selectBox("refresh");$("select[name='DATE_OF_BIRTH_YEAR_1']").val(year).selectBox("refresh");}var placeHolderMobile=clientMessages["ALLP.text.CONTACT_POINT_MOBILE_1"];var placeHolderMail=clientMessages["ALLP.text.CONTACT_POINT_EMAIL_1"];var mail=data.mapDataUI.LOGIN_INFORMATION.CONTACT_POINT_EMAIL_1;var mobileOc=data.mapDataUI.LOGIN_INFORMATION.CONTACT_POINT_MOBILE_1_OC;var mobile=data.mapDataUI.LOGIN_INFORMATION.CONTACT_POINT_MOBILE_1;if(typeof mail!=="undefined"&&mail!==""&&mail!==placeHolderMail&&clientSideData["MOCK_EMAIL"].toString()!=mail){$("input[name='CONTACT_POINT_EMAIL_1']").val(mail);}if(typeof mobileOc!=="undefined"&&mobileOc!==""){$("select[name='CONTACT_POINT_MOBILE_COUNTRY_1']").val(mobileOc).selectBox("refresh");}if(typeof mobile!=="undefined"&&mobile!==""&&mobile!==placeHolderMobile){$("input[name='CONTACT_POINT_MOBILE_NUMBER_1']").val(mobile);}}}};LateLogin.prototype.isAlpiFormChanged=function(){var alpForm=$("form[id='MAIN_ALPI_FORM']");if($("input[name='FIRST_NAME_1']",alpForm).val().length!=0||$("input[name='LAST_NAME_1']",alpForm).val().length!=0||$("input[name='PREF_AIR_FREQ_NUMBER_1']",alpForm).val().length!=0||$("input[name='CONTACT_POINT_EMAIL_1']",alpForm).val().length!=0||$("input[name='CONTACT_POINT_MOBILE_NUMBER_1']",alpForm).val().length!=0||$("select[id='TITLE_1']",alpForm).val().length!=0||$("select[id='PREF_AIR_FREQ_AIRLINE_1']",alpForm).val().length!=0||(typeof($("select[id='DATE_OF_BIRTH_DAY_1']",alpForm).val())!=="undefined"&&$("select[id='DATE_OF_BIRTH_DAY_1']",alpForm).val().length!=0)||(typeof($("select[id='DATE_OF_BIRTH_MONTH_1']",alpForm).val())!=="undefined"&&$("select[id='DATE_OF_BIRTH_MONTH_1']",alpForm).val().length!=0)||(typeof($("select[id='DATE_OF_BIRTH_YEAR_1']",alpForm).val())!=="undefined"&&$("select[id='DATE_OF_BIRTH_YEAR_1']",alpForm).val().length!=0)||$("select[name='CONTACT_POINT_MOBILE_TYPE_1']",alpForm).val().length!=0){return true;}return false;};LateLogin.prototype.callLogin=function(){var self=this;var lateLoginServiceUrl=clientSideData["WDS_LATE_LOGIN_SERVICE"];lateLoginServiceUrl=lateLoginServiceUrl.replace("http:","https:");$.ajax({url:lateLoginServiceUrl+"?METHOD=_jqjsp",data:{"FREQ_NUMBER":$("#LATE_LOGIN_USERNAME").val(),"PASSWORD":$("#LATE_LOGIN_PASSWORD").val(),"ACTION":"LOGIN"},type:"GET",async:false,contentType:"application/json",jsonpCallback:"_jqjsp",dataType:"jsonp",timeout:20000,beforeSend:function(){$.blockUI();},success:function(data,status){var isBKGDRedemption=clientSideData.REDEMPTION_FLOW=="true"&&clientSideData.PAGE_CODE=="BKGD";$.each(data.response,function(i,item){self.fillBookingListForm(item);$("#pageErrorLogin").errorPanel("reset");var hasError=false;if(item.WDS_ERROR_CODE=="00"||item.WDS_ERROR_CODE=="0"||item.WDS_ERROR_CODE=="40"||item.WDS_ERROR_CODE=="41"||item.WDS_ERROR_CODE=="42"){self.isMileageDisplayed=true;if(item.WDS_ERROR_CODE=="40"||item.WDS_ERROR_CODE=="41"||item.WDS_ERROR_CODE=="42"){self.isMileageDisplayed=false;}var isFakeLogged=(typeof clientSideData.LOGIN_INFORMATION!="undefined")&&clientSideData.LOGIN_INFORMATION.IS_FAKE_LOGGED;self.WDS_LATE_LOGIN_FORM.append("<input name='ENCT' value='1' type='hidden'>");self.WDS_SEARCH_FORM.append("<input name='ENCT' value='1' type='hidden'>");self.WDS_LOGOUT_FORM.append("<input name='ENCT' value='1' type='hidden'>");for(var key in item){if(item.hasOwnProperty(key)){var tmpKey=key;if(tmpKey!="WDS_CONTACT_PHONES"&&tmpKey!="WDS_CONTACT_MOBILES"){tmpKey=tmpKey.replace("WDS_","");}var addProfileInputsToReloadForm=(isFakeLogged||isBKGDRedemption)&&clientSideData.PAGE_CODE!="RD_MO_CALD";if(key==="WDS_IS_ITAU"){self.WDS_LATE_LOGIN_FORM.append("<input name='"+key+"' value='"+item[key]+"' type='hidden'>");self.WDS_SEARCH_FORM.append("<input name='"+key+"' value='"+item[key]+"' type='hidden'>");if((addProfileInputsToReloadForm)&&clientSideData.PAGE_CODE!="RD_MO_CALD"){self.WDS_LOGOUT_FORM.append("<input name='"+key+"' value='"+item[key]+"' type='hidden'>");}}if(tmpKey!="ENC"&&tmpKey!="ERROR_CODE"&&tmpKey!="CONTACT_POINT_MOBILE_OC"&&tmpKey!="WDS_CONTACT_PHONES"&&tmpKey!="WDS_CONTACT_MOBILES"){self.WDS_LATE_LOGIN_FORM.append("<input name='"+tmpKey+"_1' value='"+item[key]+"' type='hidden'>");self.WDS_SEARCH_FORM.append("<input name='"+tmpKey+"_1' value='"+item[key]+"' type='hidden'>");if(addProfileInputsToReloadForm){self.WDS_LOGOUT_FORM.append("<input name='"+tmpKey+"_1' value='"+item[key]+"' type='hidden'>");}}else{if(tmpKey=="CONTACT_POINT_MOBILE_OC"){self.WDS_LATE_LOGIN_FORM.append("<input name='CONTACT_POINT_MOBILE_1_OC' value='"+item[key]+"' type='hidden'>");self.WDS_SEARCH_FORM.append("<input name='CONTACT_POINT_MOBILE_1_OC' value='"+item[key]+"' type='hidden'>");if(addProfileInputsToReloadForm){self.WDS_LOGOUT_FORM.append("<input name='CONTACT_POINT_MOBILE_1_OC' value='"+item[key]+"' type='hidden'>");}}else{self.WDS_LATE_LOGIN_FORM.append("<input name='"+tmpKey+"' value='"+item[key]+"' type='hidden'>");self.WDS_SEARCH_FORM.append("<input name='"+tmpKey+"' value='"+item[key]+"' type='hidden'>");if(addProfileInputsToReloadForm){self.WDS_LOGOUT_FORM.append("<input name='"+tmpKey+"' value='"+item[key]+"' type='hidden'>");}}}}}var pageCode=clientSideData.PAGE_CODE;if(pageCode=="RD_MO_CALD"){for(var key in item){if(item.hasOwnProperty(key)){var tmpKey=key;tmpKey=tmpKey.replace("WDS_","");if(tmpKey!="ENC"&&tmpKey!="ERROR_CODE"&&tmpKey!="CONTACT_POINT_MOBILE_OC"){self.WDS_REDEMPTION_FORM.append("<input name='"+tmpKey+"_1' value='"+item[key]+"' type='hidden'>");}else{if(tmpKey=="CONTACT_POINT_MOBILE_OC"){self.WDS_REDEMPTION_FORM.append("<input name='CONTACT_POINT_MOBILE_1_OC' value='"+item[key]+"' type='hidden'>");}else{self.WDS_REDEMPTION_FORM.append("<input name='"+tmpKey+"' value='"+item[key]+"' type='hidden'>");}}}}self.WDS_REDEMPTION_FORM.append("<input name='DIRECT_LOGIN' value='YES' type='hidden'>");var jsessionIndex=self.WDS_REDEMPTION_FORM.attr("action").indexOf(";jsessionid");self.WDS_REDEMPTION_FORM.attr("action",self.WDS_REDEMPTION_FORM.attr("action").substr(0,jsessionIndex));}}else{hasError=true;$("#pageErrorLogin").errorPanel();$("#pageErrorLogin").errorPanel("addError",null,null,clientMessages["ALLP.error.LateLogin."+item.WDS_ERROR_CODE]);$(window).scrollTop(0);}$.unblockUI();if(!hasError){if(clientSideData.PAGE_CODE=="RD_UPSL"||isBKGDRedemption){$.blockUI();if(clientSideData.PAGE_CODE=="RD_UPSL"){if($(".outbound  .selectedFF").length>0){self.WDS_LOGOUT_FORM.append("<input name='outboundPreselected' value='"+theUtils.getPreselectedFlight("outbound")+"' type='hidden'>");self.WDS_LOGOUT_FORM.append("<input name='outboundPreselectedFlightNumber' value='"+theUtils.getPreselectedFlightNumber("outbound")+"' type='hidden'>");self.WDS_LOGOUT_FORM.append("<input name='outboundPreselectedFf' value='"+theUtils.getPreselectedFf("outbound")+"' type='hidden'>");}if($(".inbound  .selectedFF").length>0){self.WDS_LOGOUT_FORM.append("<input name='inboundPreselected' value='"+theUtils.getPreselectedFlight("inbound")+"' type='hidden'>");self.WDS_LOGOUT_FORM.append("<input name='inboundPreselectedFlightNumber' value='"+theUtils.getPreselectedFlightNumber("inbound")+"' type='hidden'>");self.WDS_LOGOUT_FORM.append("<input name='inboundPreselectedFf' value='"+theUtils.getPreselectedFf("inbound")+"' type='hidden'>");}}self.WDS_LOGOUT_FORM.submit();}else{self.doLateLogin();}}});},error:function(XHR,textStatus,errorThrown){$("#pageErrorLogin").errorPanel();$("#pageErrorLogin").errorPanel("addError",null,null,clientMessages["ALLP.error.TimeOutLateLogin"]);$.unblockUI();}});};LateLogin.prototype.fillBookingListForm=function(data){var form=self.BOOKING_LIST_FORM;if(self.BOOKING_LIST_FORM.length>0){$(form).append('<input type="hidden" name="ENC" value="'+data.ENC+'" />');$(form).append('<input type="hidden" name="FIRST_NAME_1" value="'+data.WDS_FIRST_NAME+'" />');$(form).append('<input type="hidden" name="LAST_NAME_1" value="'+data.WDS_LAST_NAME+'" />');$(form).append('<input type="hidden" name="TITLE_1" value="'+data.WDS_TITLE+'" />');$(form).append('<input type="hidden" name="CONTACT_POINT_MOBILE_1_OC" value="'+data.WDS_CONTACT_POINT_MOBILE_OC+'" />');$(form).append('<input type="hidden" name="CONTACT_POINT_MOBILE_1" value="'+data.WDS_CONTACT_POINT_MOBILE+'" />');$(form).append('<input type="hidden" name="CONTACT_POINT_EMAIL_1" value="'+data.WDS_CONTACT_POINT_EMAIL+'" />');$(form).append('<input type="hidden" name="DATE_OF_BIRTH_1" value="'+data.WDS_DATE_OF_BIRTH+'" />');$(form).append('<input type="hidden" name="DIRECT_LOGIN" value="YES" />');}};$(function(){window.theLateLogin=new LateLogin();});